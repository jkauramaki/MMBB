<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>MMBB - login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
    <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.13.0/firebase-auth-compat.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.13.0/firebase-app.js"></script>
    <link href="./src/styles/frontPageStyles.css" rel="stylesheet" type="text/css"/>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
    <script src="./utils/manageCookies.js"></script>
    <script src="./utils/studyLinks.js"></script>

    <script src="./backend/pushDatabase.js"></script>
    <script src="./backend/setupLogFile.js"></script>

    <script src="jatos.js"></script>
  </head>

  <body>
    <div id="header">
      <span id="buttonOpen" onclick="openNav()">&#9776;</span>
      <img id="gif" src="./images/coe.gif" />
    </div>

    <div id="mySidenav" class="sidenav">
      <div id="header">
        <img id="gifSideNav" src="./images/coe.gif" />
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      </div>
      <div id="userName"></div>
      <button id="logoutBtn" onclick="signOut()">Logout</button>
    </div>

    <div id="langs">
      <button id="langEng">English</button>
      <button id="langFi">Finnish</button>
    </div>
    <div id="container">
      <div id="choicesEng">
        <div id="taskMovement"><div id="linkToMovement" href=""><img src="./images/dance.svg"/></div><div id="movementTaskIcon"></div></div>
        <div id="taskSinging" disabled><div id="linkToSinging" onclick='alert("Under construction. Come back later.")'><img src="./images/singing.svg"/></div><div id="singingTaskIcon"></div></div>
        <div id="taskEmotion" disabled><div id="linkToEmotion"><img src="./images/emotion.svg"/></div><div id="emotionTaskIcon"></div></div>
        <div id="taskSharedMeasures" disabled><div id="linkToSurvey"><img src="./images/survey.svg"/></div><div id="surveyTaskIcon"></div></div>
      </div>
    </div>

    <div id="footer"
      <a href="https://www.jyu.fi/hytk/fi/laitokset/mutku/en/coe-mmbb">MMBB - CoE</a>
    </div>

  </body>

  <script src="./utils/langFetch.js"></script>
  <script src="./utils/translations.js"></script>
  <script src="./utils/manageCookies.js"></script>
  <script src="./backend/firebaseSetUp.js"></script>
  <script src="./backend/firebaseLoginLogout.js"></script>

  <script>

    function openNav() {
      document.getElementById("mySidenav").style.width = "100%";
    }

    function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
    }

    //Check which tasks have been done
    var allTasksLinks = ["Emotion", "Singing", "SharedMeasures", "Movement"]
    allTasksLinks.map(i => {
      if(getCookie(i) == "done"){
        document.getElementById("task" + i).style.background = "lightgreen";
      }
    })

    jatos.onLoad(() => {

      var lang = jatos.urlQueryParameters.lang
      if(lang == undefined){
        var lang = 'eng'
      }

      function changeLangURL(lang){
        var urlRedirect = studyLinks['chooseBatteryLink'] + "?lang=" + lang
        jatos.endStudyAndRedirect(urlRedirect)
      }

      document.getElementById("movementTaskIcon").innerHTML = tasksIcons['movement'][lang]
      document.getElementById("singingTaskIcon").innerHTML = tasksIcons['singing'][lang]
      document.getElementById("emotionTaskIcon").innerHTML = tasksIcons['emotion'][lang]
      document.getElementById("surveyTaskIcon").innerHTML = tasksIcons['survey'][lang]


      document.getElementById("langEng").onclick = function(){
        changeLangURL("eng")
      }
      document.getElementById("langFi").onclick = function(){
        changeLangURL("fi")
      }


      //Watch if user logged in
      firebase.auth().onAuthStateChanged(user => {
        if(user){ //If user logged in, stay in choose battery, else go to auth
          document.getElementById("userName").innerHTML = "Hello, " + user.displayName
          var userIDFirebase = user.uid
          document.getElementById("linkToMovement").onclick = function(){
            var movementRedirect = studyLinks['movementLink'] + '?lang=' + lang + '&user=' + userIDFirebase
            jatos.endStudyAndRedirect(movementRedirect)
          }
          document.getElementById("linkToEmotion").onclick = function(){
            var emotionRedirect = studyLinks['emotionLink'] + '?lang=' + lang + '&user=' + userIDFirebase
            jatos.endStudyAndRedirect(emotionRedirect)
          }
          document.getElementById("taskSharedMeasures").onclick = function(){
            var sharedDirect = studyLinks['sharedLink'] + '?lang=' + lang + '&user=' + userIDFirebase
            jatos.endStudyAndRedirect(sharedDirect)
          }
          //document.getElementById("linkToSurvey").href = './src/batteries/movementWrap.html?lang=' + lang
          //document.getElementById("linkToSinging").href = './src/batteries/movementWrap.html?lang=' + lang
        } else {
          jatos.endStudyAndRedirect(studyLinks["frontPageLink"])
        }
      })

    })


  </script>

</html>
