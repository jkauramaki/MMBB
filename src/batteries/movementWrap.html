<!DOCTYPE html>
<html>
  <head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="./langFetch.js"></script>
    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="../../jspsych/dist/plugin-html-songselector-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-slider-response.js"></script>
    <script src="../../jspsych/dist/plugin-audio-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-instructions.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-likert.js"> </script>
    <script src="../../jspsych/dist/plugin-canvas-button-response.js"> </script>
    <script src="../../jspsych/dist/extension-accelerometer.js"> </script>
    <script src="../../jspsych/dist/plugin-html-keyboard-response.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-multi-choice.js"> </script>
    <script src="../../jspsych/dist/plugin-initialize-microphone.js"> </script>
    <script src="../../jspsych/dist/plugin-audio-keyboard-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-audio-response.js"> </script>
    <script src="../../jspsych/dist/plugin-preload.js"> </script>
    <script src="../../songs/movementTapAudio/songKeysNames.js"> </script>
    <script src="../../jspsych/dist/custom/utils.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-html-form.js"> </script>
    <script src="../../jspsych/dist/custom/beatProductionFunctions.js"></script>
    <script src="../../songs/movementTapAudio/songKeysNames.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css">

    <script src="./translations.js"></script>
    <script src="./generalIntro.js"></script>

    <!--Fetching timelines for each task-->
    <script src="./movement.js"> </script>
    <script src="./bat.js"> </script>
    <script src="./tapping.js"> </script>

    <link rel="stylesheet" href="./generalCSS.css">

    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-firestore.js"></script>

    <script src="../../jspsych/dist/custom/audioContextMonkeyPatch.js"></script>

  </head>

  <body></body>

  <script>

    //For all browsers except Safari IOS
    window.onbeforeunload = function() {
      return "If you leave now, data may not be saved";
    }

    //Send errors to firebase
    window.addEventListener("error", (event) => {
          var userID = urlParams.get('user')
          var data = {"errorLog": event, 'userID': userID}
          const firebaseConfig = {
                  apiKey: "AIzaSyD7Sxzak9C4RIA23s1FbVvOEvx-CTNnfoI",
                  authDomain: "sequence-e4afd.firebaseapp.com",
                  projectId: "sequence-e4afd",
                  storageBucket: "sequence-e4afd.appspot.com",
                  messagingSenderId: "743153626983",
                  appId: "1:743153626983:web:b89bfbaca62f28495749c2"
          };
          var app = firebase.initializeApp(firebaseConfig);
          var db = firebase.firestore();
          var expcoll = db.collection("riikka")
          var result_obj = {r : JSON.parse(data.json())}
          expcoll.add(result_obj)
    });

    //For safari IOS
    function preventRefresh(event) { event.preventDefault(); }
    window.addEventListener("onbeforeunload", preventRefresh, false);

    var jsPsych = initJsPsych({
      extensions: [
        {type: jsPsychExtensionAccelerometer }
      ],
      on_finish: function() {

        try{
          var finalData = jsPsych.data.get()
          var measurePerformance = performance.getEntriesByType('resource');
          var userID = urlParams.get('user')

          finalData['trials'].push({"performance": measurePerformance, "infoUser": navigator.userAgent, 'userID': userID})

          const firebaseConfig = {
                  apiKey: "AIzaSyD7Sxzak9C4RIA23s1FbVvOEvx-CTNnfoI",
                  authDomain: "sequence-e4afd.firebaseapp.com",
                  projectId: "sequence-e4afd",
                  storageBucket: "sequence-e4afd.appspot.com",
                  messagingSenderId: "743153626983",
                  appId: "1:743153626983:web:b89bfbaca62f28495749c2"
                  // measurementId: "G-T2N115QG7L"
          };
          var app = firebase.initializeApp(firebaseConfig);
          var db = firebase.firestore();
          var expcoll = db.collection("riikka")
          var result_obj = {r : JSON.parse(finalData.json())}
          expcoll.add(result_obj)
        } catch(e){
          alert(e)
        }
      }
    });

    var sequenceTasks = [movementTimeline, batTimeline, tappingTimeline]
    var sequenceTasks = jsPsych.randomization.shuffle(sequenceTasks);

    var completeSequence = [generalIntroWrap, sequenceTasks[0], sequenceTasks[1], sequenceTasks[2], messageEndTask]
    var completeSequence = completeSequence.flat()

    //jsPsych.run(completeSequence);
    jsPsych.run(batTimeline);

 </script>
</html>
