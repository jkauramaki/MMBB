<!DOCTYPE html>
<html>
  <head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="./langFetch.js"></script>
    <script src="./preventRefresh.js"> </script>

    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="../../jspsych/dist/plugin-html-songselector-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-slider-response.js"></script>
    <script src="../../jspsych/dist/plugin-audio-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-instructions.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-likert.js"> </script>
    <script src="../../jspsych/dist/plugin-canvas-button-response.js"> </script>
    <script src="../../jspsych/dist/extension-accelerometer.js"> </script>
    <script src="../../jspsych/dist/plugin-html-keyboard-response.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-multi-choice.js"> </script>
    <script src="../../jspsych/dist/plugin-initialize-microphone.js"> </script>
    <script src="../../jspsych/dist/plugin-audio-keyboard-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-audio-response.js"> </script>
    <script src="../../jspsych/dist/plugin-preload.js"> </script>
    <script src="../../songs/movementTapAudio/songKeysNames.js"> </script>
    <script src="../../jspsych/dist/custom/utils.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-html-form.js"> </script>
    <script src="../../jspsych/dist/custom/beatProductionFunctions.js"></script>
    <script src="../../songs/movementTapAudio/songKeysNames.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css">

    <script src="./translations.js"></script>
    <script src="./generalIntro.js"></script>

    <!--Fetching timelines for each task-->
    <script src="./movement.js"> </script>
    <script src="./bat.js"> </script>
    <script src="./tapping.js"> </script>

    <link rel="stylesheet" href="./generalCSS.css">

    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-firestore.js"></script>

    <script src="../backend/pushDatabase.js"></script>

  </head>

  <body></body>

  <script>

    //Which trial to be performed
    var nodeIndex = urlParams.get('nodeIndex')
    if(nodeIndex == undefined){
      var nodeIndex = 0
    }
    var trialIndex = urlParams.get('trialIndex')
      if(trialIndex == undefined){
      var trialIndex = 0
    }

    var jsPsych = initJsPsych({
      extensions: [
        {type: jsPsychExtensionAccelerometer }
      ],
      on_finish: function() {

        var measurePerformance = performance.getEntriesByType('resource');
        var userID = urlParams.get('user')
        var nIndex = urlParams.get('nodeIndex')
        var tIndex = urlParams.get('tIndex')

        jsPsych.data.addProperties({userID: userID, sequenceTrials: document.cookie, nodeIndex: nIndex, tIndex: tIndex});

        var finalData = jsPsych.data.get()
        finalData['trials'].push({"performance": measurePerformance, "infoUser": navigator.userAgent})

        pushDatabase("riikka", finalData).then(r => {
          var nNodes = completeSequence.length-1
          var nTrials = completeSequence[nodeIndex].length-1
          if(Number(trialIndex) < Number(nTrials)){
            window.trialIndex = Number(trialIndex)+1
            //window.location = "http://[::]:8000/src/batteries/movementWrap.html?user=" + userID + "&trialIndex=" + trialIndex + "&nodeIndex=" + nodeIndex
            window.location = "https://pasoneto.github.io/MMBB/src/batteries/movementWrap.html?user=" + userID + "&trialIndex=" + trialIndex + "&nodeIndex=" + nodeIndex
          } else {
            //If there's another node, go to the next one
            if(Number(window.nodeIndex) < nNodes){
              window.trialIndex = Number(0)
              window.nodeIndex = Number(window.nodeIndex)+1

              //window.location = "http://[::]:8000/src/batteries/movementWrap.html?user=" + userID + "&trialIndex=" + trialIndex + "&nodeIndex=" + nodeIndex
              window.location = "https://pasoneto.github.io/MMBB/src/batteries/movementWrap.html?user=" + userID + "&trialIndex=" + trialIndex + "&nodeIndex=" + nodeIndex
            } else { //If end of experiment. Redirect to homepage
              window.location = "https://pasoneto.github.io/MMBB/"
            }
          }
        })
      }
    });
    
    var sequenceTrials = {
      intro: generalIntroWrap,
      movement: movementTimeline,
      bat: batTimeline,
      tapping: tappingTimeline
    }
    var alreadyStored = document.cookie.includes("tapping");
    
    if(!alreadyStored){
      var indexTrial = jsPsych.randomization.shuffle(["movement", "bat", "tapping"]);
      document.cookie = indexTrial.replace('=', '');
    }

    indexTrial = document.cookie.split(",")
    indexTrial[2] = indexTrial[2].replace('=', '')
    var completeSequence = [sequenceTrials["intro"], sequenceTrials[indexTrial[0]], sequenceTrials[indexTrial[1]], sequenceTrials[indexTrial[2]]]

    jsPsych.run(completeSequence[Number(nodeIndex)][trialIndex])


 </script>
</html>
