<!DOCTYPE html>
<html>
  <head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="./langFetch.js"></script>
    <script src="./preventRefresh.js"> </script>

    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="../../jspsych/dist/plugin-html-songselector-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-slider-response.js"></script>
    <script src="../../jspsych/dist/plugin-audio-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-button-response.js"> </script>
    <script src="../../jspsych/dist/plugin-instructions.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-likert.js"> </script>
    <script src="../../jspsych/dist/plugin-canvas-button-response.js"> </script>
    <script src="../../jspsych/dist/extension-accelerometer.js"> </script>
    <script src="../../jspsych/dist/plugin-html-keyboard-response.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-multi-choice.js"> </script>
    <script src="../../jspsych/dist/plugin-initialize-microphone.js"> </script>
    <script src="../../jspsych/dist/plugin-audio-keyboard-response.js"> </script>
    <script src="../../jspsych/dist/plugin-html-audio-response.js"> </script>
    <script src="../../jspsych/dist/plugin-preload.js"> </script>
    <script src="../../songs/movementTapAudio/songKeysNames.js"> </script>
    <script src="../../jspsych/dist/custom/utils.js"> </script>
    <script src="../../jspsych/dist/plugin-survey-html-form.js"> </script>
    <script src="../../jspsych/dist/custom/beatProductionFunctions.js"></script>
    <script src="../../songs/movementTapAudio/songKeysNames.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css">

    <script src="./translations.js"></script>
    <script src="./generalIntro.js"></script>

    <!--Fetching timelines for each task-->
    <script src="./movement.js"> </script>
    <script src="./bat.js"> </script>
    <script src="./tapping.js"> </script>

    <link rel="stylesheet" href="./generalCSS.css">

    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.10.1/firebase-firestore.js"></script>

    <script src="../../jspsych/dist/custom/audioContextMonkeyPatch.js"></script>

  </head>

  <body></body>

  <script>

    //Which trial to be performed
    var nodeIndex = urlParams.get('nodeIndex')
    if(nodeIndex == undefined){
      var nodeIndex = 0
    }
    var trialIndex = urlParams.get('trialIndex')
      if(trialIndex == undefined){
      var trialIndex = 0
    }

    //Send errors to firebase
    window.addEventListener("error", (event) => {
          var userID = urlParams.get('user')
          var data = {"errorLog": event, 'userID': userID}
          const firebaseConfig = {
                  apiKey: "AIzaSyD7Sxzak9C4RIA23s1FbVvOEvx-CTNnfoI",
                  authDomain: "sequence-e4afd.firebaseapp.com",
                  projectId: "sequence-e4afd",
                  storageBucket: "sequence-e4afd.appspot.com",
                  messagingSenderId: "743153626983",
                  appId: "1:743153626983:web:b89bfbaca62f28495749c2"
          };
          var app = firebase.initializeApp(firebaseConfig);
          var db = firebase.firestore();
          var expcoll = db.collection("riikka")
          var result_obj = {r : JSON.parse(data.json())}
          expcoll.add(result_obj)
    });


    var jsPsych = initJsPsych({
      extensions: [
        {type: jsPsychExtensionAccelerometer }
      ],
      on_finish: function() {

        try{
          var finalData = jsPsych.data.get()
          var measurePerformance = performance.getEntriesByType('resource');
          var userID = urlParams.get('user')

          finalData['trials'].push({"performance": measurePerformance, "infoUser": navigator.userAgent, 'userID': userID})

          const firebaseConfig = {
                  apiKey: "AIzaSyD7Sxzak9C4RIA23s1FbVvOEvx-CTNnfoI",
                  authDomain: "sequence-e4afd.firebaseapp.com",
                  projectId: "sequence-e4afd",
                  storageBucket: "sequence-e4afd.appspot.com",
                  messagingSenderId: "743153626983",
                  appId: "1:743153626983:web:b89bfbaca62f28495749c2"
                  // measurementId: "G-T2N115QG7L"
          };
          //var app = firebase.initializeApp(firebaseConfig);
          //var db = firebase.firestore();
          //var expcoll = db.collection("riikka")
          //var result_obj = {r : JSON.parse(finalData.json())}
          //expcoll.add(result_obj)
          var nNodes = completeSequence.length-1
          var nTrials = completeSequence[nodeIndex].length-1
          if(Number(trialIndex) < Number(nTrials)){
            console.log("first")
            window.trialIndex = Number(trialIndex)+1
          } else {
            //If there's another node, go to the next one
            if(Number(window.nodeIndex) < nNodes){
              window.trialIndex = Number(0)
              window.nodeIndex = Number(window.nodeIndex)+1

              window.location = "http://[::]:8000/src/batteries/movementWrap.html?user=" + userID + "&trialIndex=" + trialIndex + "&nodeIndex=" + nodeIndex
              window.location = "https://pasoneto.github.io/MMBB/src/batteries/movementWrap.html?user=" + userID + "&trialIndex=" + trialIndex + "&nodeIndex=" + nodeIndex
            } else { //If end of experiment. Redirect to homepage
              window.location = "https://pasoneto.github.io/MMBB/"
            }
          }
        } catch(e){
          alert(e)
        }
      }
    });

    var completeSequence = [[generalIntroWrap], [movementTimeline], batTimeline, [tappingTimeline]]
    //var completeSequence = jsPsych.randomization.shuffle(completeSequence);

    jsPsych.run(completeSequence[Number(nodeIndex)][trialIndex])


 </script>
</html>
